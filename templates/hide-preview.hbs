{{!--
  ApplicationV2 template for Hide Results Preview Dialog
  Matches the visibility manager's design and styling
--}}

<div class="hide-preview-content">
  {{!-- Hiding Token Information Panel --}}
  <div class="hider-info">
    <div class="hider-image">
      <img src="{{actorToken.document.texture.src}}" alt="{{actorToken.name}}" />
    </div>
    <div class="hider-details">
      <h3 class="hider-name">{{actorToken.name}}</h3>
      <p class="hint">Attempting to hide from observers</p>
    </div>
  </div>

  {{!-- Encounter Filter + Ignore Allies (Encounter-only shown when relevant; Ignore allies always shown) --}}
  <div class="encounter-filter-section" style="display:flex; gap:16px; align-items:center;">
    {{#if showEncounterFilter}}
    <label class="encounter-filter-checkbox" style="display:flex; align-items:center; gap:8px;">
      <input type="checkbox" {{#if encounterOnly}}checked{{/if}} data-action="toggleEncounterFilter" data-tooltip="Only show tokens in the current encounter" />
      <span class="encounter-filter-label">{{localize "PF2E_VISIONER.UI.ENCOUNTER_FILTER_TEXT"}}</span>
    </label>
    {{/if}}
    <label class="ignore-allies-filter-checkbox" style="display:flex; align-items:center; gap:8px;">
      <input type="checkbox" {{#if ignoreAllies}}checked{{/if}} data-action="toggleIgnoreAllies" data-tooltip="Hide allies from the results list" />
      <span class="encounter-filter-label">Ignore allies</span>
    </label>
  </div>

  {{!-- Results Table --}}
  <div class="results-table-container">
    <table class="visibility-table hide-results-table">
      <thead>
        <tr>
          <th class="token-image">Token</th>
          <th class="token-name">Name</th>
          <th class="auto-cover">Cover</th>
          <th class="roll-result">Roll vs Perception DC</th>
          <th class="outcome">Outcome</th>
          <th class="visibility-change">Visibility Change</th>
          <th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        {{#each outcomes as |outcome|}}
          <tr class="token-row" data-token-id="{{outcome.target.id}}">
            <td class="token-image">
              <img src="{{outcome.tokenImage}}" alt="{{outcome.target.name}}" width="28" height="28" />
            </td>
            <td class="token-name">
              <strong>{{outcome.target.name}}</strong>
            </td>
            <td class="auto-cover">
              {{#if outcome.autoCover}}
                <div class="auto-cover-info-hide {{#if outcome.autoCover.isOverride}}override{{/if}}">
                  {{#if outcome.autoCover.isOverride}}
                    {{#if outcome.autoCover.overrideDetails}}
                      <!-- Show detailed override indicator with original → final transition -->
                      <span class="auto-cover-override-detailed" 
                            data-tooltip="Cover overridden {{#if (eq outcome.autoCover.source 'popup')}}via keybind popup{{else if (eq outcome.autoCover.source 'dialog')}}in roll dialog{{else}}manually{{/if}}: {{outcome.autoCover.overrideDetails.originalLabel}} → {{outcome.autoCover.overrideDetails.finalLabel}}">
                        <!-- Original state (no crossing out) -->
                        <span class="original-cover" style="
                          color: {{outcome.autoCover.overrideDetails.originalColor}};
                          display: inline-flex;
                          align-items: center;
                        ">
                          <i class="{{outcome.autoCover.overrideDetails.originalIcon}}" style="font-size: 1.1em;"></i>
                        </span>
                        <!-- Arrow -->
                        <i class="fas fa-arrow-right" style="
                          color: #999;
                          font-size: 1em;
                          margin: 0 2px;
                        "></i>
                        <!-- Final state -->
                        <span class="final-cover" style="
                          color: {{outcome.autoCover.overrideDetails.finalColor}};
                          display: inline-flex;
                          align-items: center;
                        ">
                          <i class="{{outcome.autoCover.overrideDetails.finalIcon}}" style="font-size: 1.1em;"></i>
                        </span>
                      </span>
                    {{else}}
                      <!-- Fallback: simple override indicator -->
                      <span class="auto-cover-icon">
                        <i class="{{outcome.autoCover.icon}} {{outcome.autoCover.cssClass}}"></i>
                      </span>
                    {{/if}}
                  {{else}}
                    <!-- Normal display without override -->
                    <span class="auto-cover-icon" data-tooltip="{{outcome.autoCover.label}}{{#if outcome.autoCover.bonus}} (+{{outcome.autoCover.bonus}} Stealth){{/if}}">
                      <i class="{{outcome.autoCover.icon}} {{outcome.autoCover.cssClass}}"></i>
                    </span>
                  {{/if}}
                </div>
              {{else}}
                <span class="auto-cover-icon no-cover" data-tooltip="No Cover (+0 Stealth)">
                  <i class="fas fa-shield-slash cover-none" style="color: var(--cover-none, #4caf50);"></i>
                </span>
              {{/if}}
            </td>
            <td class="roll-result">
              <div class="roll-vs-dc">
                <div class="roll-dc-line">
                  <span class="roll-total">{{outcome.rollTotal}}</span>
                  {{#if (and outcome.shouldShowOverride outcome.originalRollTotal)}}
                    <span class="original-roll-total" style="font-size: 1em; opacity: 0.7; margin-left: 2px;">
                      ({{outcome.originalRollTotal}})
                    </span>
                  {{/if}}
                  <span class="vs-text">vs DC</span>
                  <span class="dc-value">{{outcome.dc}}</span>
                </div>
                <div class="margin-display">({{#if (gt outcome.margin 0)}}+{{/if}}{{outcome.margin}})
                  {{#if (and outcome.shouldShowOverride outcome.originalMargin)}}
                    <span style="font-size: 1em; opacity: 0.7; margin-left: 2px;">
                      ({{#if (gt outcome.originalMargin 0)}}+{{/if}}{{outcome.originalMargin}})
                    </span>
                  {{/if}}
                </div>
              </div>
            </td>
            <td class="outcome {{outcome.outcomeClass}}">
              <div>{{outcome.outcomeLabel}}</div>
              {{#if (and outcome.shouldShowOverride outcome.originalOutcomeLabel)}}
                <div style="font-size: 1em; opacity: 0.7; margin-top: 2px;">
                  ({{outcome.originalOutcomeLabel}})
                </div>
              {{/if}}
            </td>
            <td class="visibility-change">
              <div class="visibility-change-inline">
                <span class="state-icon" data-state="{{outcome.oldVisibility}}" data-tooltip="{{outcome.oldVisibilityLabel}}">
                  {{{visibilityIcon outcome.oldVisibility}}}
                </span>
                <i class="fas fa-arrow-right visibility-arrow"></i>
                <div class="override-icons">
                  {{#each outcome.availableStates as |state|}}
                    <span class="state-icon {{#if (eq state.value outcome.overrideState)}}selected{{/if}} {{#if state.calculatedOutcome}}calculated-outcome{{/if}}" 
                          data-state="{{state.value}}" data-token-id="{{../outcome.target.id}}" data-tooltip="{{state.label}}">
                      {{{visibilityIcon state.value}}}
                    </span>
                  {{/each}}
                </div>
              </div>
              {{#if (and outcome.shouldShowOverride outcome.originalNewVisibility)}}
                <div class="original-visibility-change" style="font-size: 1em; opacity: 0.7; padding-top: 5px; display: flex; align-items: center;">
                  <span>Original Change:</span>
                  <span class="state-icon" data-state="{{outcome.originalNewVisibility}}" data-tooltip="Original Cover: {{outcome.originalNewVisibility}}" style="margin-left: 4px;">
                    {{{visibilityIcon outcome.originalNewVisibility}}}
                  </span>
                </div>
              {{/if}}
            </td>
            <td class="actions">
              {{#if outcome.hasActionableChange}}
                <button type="button" class="row-action-btn apply-change" data-action="applyChange" data-token-id="{{outcome.target.id}}" data-tooltip="Apply this visibility change">
                  <i class="fas fa-check"></i>
                </button>
                <button type="button" class="row-action-btn revert-change" data-action="revertChange" data-token-id="{{outcome.target.id}}" data-tooltip="Revert to original visibility">
                  <i class="fas fa-undo"></i>
                </button>
              {{else}}
                <span class="no-action">No Change</span>
              {{/if}}
            </td>
          </tr>
        {{/each}}
      </tbody>
    </table>
  </div>

  {{!-- Bulk Actions --}}
  <div class="hide-preview-dialog-bulk-actions-header">
    <div class="hide-preview-dialog-bulk-actions-info">
      <span class="hide-preview-dialog-changes-count">{{changesCount}}</span> of <span class="hide-preview-dialog-total-count">{{totalCount}}</span> observers will have visibility changes.
    </div>
    <div class="hide-preview-dialog-bulk-actions-buttons">
      <button type="button" class="bulk-action-btn apply-all" data-action="applyAll" data-tooltip="Apply all visibility changes">
        <i class="fas fa-check-circle"></i> Apply All
      </button>
      <button type="button" class="bulk-action-btn revert-all" data-action="revertAll" data-tooltip="Revert all changes to original state" disabled>
        <i class="fas fa-undo"></i> Revert All
      </button>
    </div>
  </div>
</div>
